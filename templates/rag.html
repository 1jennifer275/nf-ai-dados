<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Busca Inteligente RAG - NF-AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-6 py-5">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-11 h-11 bg-black rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Busca Inteligente RAG</h1>
                        <p class="text-sm text-gray-600">Pergunte qualquer coisa sobre suas notas fiscais</p>
                    </div>
                </div>
                <nav class="flex items-center space-x-2">
                    <a href="/" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-black hover:bg-gray-100 rounded-lg transition-colors">Início</a>
                    <a href="/crud/pessoas" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-black hover:bg-gray-100 rounded-lg transition-colors">CRUD</a>
                    <a href="/admin" class="px-5 py-2.5 bg-black text-white rounded-lg hover:bg-gray-800 transition-all shadow-sm font-medium text-sm">
                        Admin
                    </a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-6 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Query Card -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8">
                    <div class="flex items-center space-x-3 mb-6">
                        <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                            </svg>
                        </div>
                        <h2 class="text-xl font-bold text-gray-900">Sua Pergunta</h2>
                    </div>
                    
                    <textarea id="pergunta" rows="4" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-gray-900 focus:border-gray-900 resize-none text-gray-900 placeholder-gray-500 transition-all" placeholder="Digite sua pergunta aqui... Ex: Quais foram as despesas maiores de Novembro de 2024?"></textarea>
                    
                    <button onclick="buscar()" class="mt-4 w-full bg-black hover:bg-gray-800 text-white font-semibold py-4 px-6 rounded-xl transition-all shadow-md hover:shadow-lg">
                        Buscar Resposta
                    </button>
                </div>

                <!-- Predefined Questions -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8">
                    <div class="flex items-center space-x-3 mb-6">
                        <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                        </div>
                        <h2 class="text-xl font-bold text-gray-900">Perguntas Rápidas</h2>
                    </div>
                    
                    <div class="space-y-2">
                        <button onclick="setPergunta('Quais despesas maiores do mês atual?')" class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-sm text-gray-700 hover:text-black border border-transparent hover:border-gray-200 font-medium">
                            Quais despesas maiores do mês atual?
                        </button>
                        <button onclick="setPergunta('Mostre parcelas vencendo esta semana')" class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-sm text-gray-700 hover:text-black border border-transparent hover:border-gray-200 font-medium">
                            Mostre parcelas vencendo esta semana
                        </button>
                        <button onclick="setPergunta('Qual fornecedor tem mais movimentos?')" class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-sm text-gray-700 hover:text-black border border-transparent hover:border-gray-200 font-medium">
                            Qual fornecedor tem mais movimentos?
                        </button>
                        <button onclick="setPergunta('Total de receitas e despesas do ano')" class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-sm text-gray-700 hover:text-black border border-transparent hover:border-gray-200 font-medium">
                            Total de receitas e despesas do ano
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loading" class="hidden bg-white rounded-2xl shadow-sm border border-gray-200 p-8">
                    <div class="flex items-center justify-center space-x-3">
                        <svg class="animate-spin h-6 w-6 text-black" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-gray-900 font-semibold">Processando sua pergunta...</span>
                    </div>
                </div>

                <!-- Results -->
                <div id="results" class="hidden space-y-6">
                    <!-- Answer Card -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8">
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-10 h-10 bg-black rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <h2 class="text-xl font-bold text-gray-900">Resposta da IA</h2>
                        </div>
                        <div id="resposta" class="prose max-w-none text-gray-900 leading-relaxed"></div>
                    </div>

                    <!-- Context Card -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8">
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                                </svg>
                            </div>
                            <h2 class="text-xl font-bold text-gray-900">Contexto Recuperado</h2>
                        </div>
                        <div id="contexto" class="bg-gray-50 rounded-lg p-4 text-sm text-gray-700 font-mono overflow-x-auto"></div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-6">
                <!-- Method Selection Card -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 sticky top-6">
                    <div class="flex items-center space-x-3 mb-6">
                        <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                            </svg>
                        </div>
                        <h2 class="text-lg font-bold text-gray-900">Método de Busca</h2>
                    </div>
                    
                    <div class="space-y-3">
                        <label class="block">
                            <input type="radio" name="metodo" value="hibrido" checked class="sr-only peer">
                            <div class="p-4 rounded-xl border-2 border-gray-200 peer-checked:border-black peer-checked:bg-gray-50 cursor-pointer transition-all hover:shadow-sm">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-gray-100 peer-checked:bg-black rounded-lg flex items-center justify-center">
                                        <svg class="w-4 h-4 text-gray-900 peer-checked:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-bold text-gray-900 text-sm">Híbrido (Agent3)</p>
                                        <p class="text-xs text-gray-600 mt-0.5">Recomendado</p>
                                    </div>
                                </div>
                            </div>
                        </label>

                        <label class="block">
                            <input type="radio" name="metodo" value="simples" class="sr-only peer">
                            <div class="p-4 rounded-xl border-2 border-gray-200 peer-checked:border-black peer-checked:bg-gray-50 cursor-pointer transition-all hover:shadow-sm">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-4 h-4 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-bold text-gray-900 text-sm">RAG Simples</p>
                                        <p class="text-xs text-gray-600 mt-0.5">Busca rápida</p>
                                    </div>
                                </div>
                            </div>
                        </label>

                        <label class="block">
                            <input type="radio" name="metodo" value="embeddings" class="sr-only peer">
                            <div class="p-4 rounded-xl border-2 border-gray-200 peer-checked:border-black peer-checked:bg-gray-50 cursor-pointer transition-all hover:shadow-sm">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-4 h-4 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-bold text-gray-900 text-sm">RAG Embeddings</p>
                                        <p class="text-xs text-gray-600 mt-0.5">Busca semântica</p>
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>

                    <!-- Info Box -->
                    <div class="mt-6 p-4 bg-gray-100 rounded-lg border border-gray-200">
                        <div class="flex items-start space-x-2">
                            <svg class="w-5 h-5 text-black mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            <div>
                                <p class="text-xs font-bold text-gray-900 mb-1">Dica</p>
                                <p class="text-xs text-gray-700 leading-relaxed">O método híbrido combina filtros inteligentes com busca semântica para melhores resultados.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="/static/js/rag.js"></script>
    <script>
        function setPergunta(text) {
            document.getElementById('pergunta').value = text;
        }

        function buscar() {
            const pergunta = document.getElementById('pergunta').value;
            const metodo = document.querySelector('input[name="metodo"]:checked').value;
            
            if (!pergunta.trim()) {
                alert('Por favor, digite uma pergunta');
                return;
            }

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');

            const endpoint = metodo === 'simples' ? '/rag/query-simples' :
                           metodo === 'embeddings' ? '/rag/query-embeddings' :
                           '/rag/query';

            fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pergunta })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('results').classList.remove('hidden');
                document.getElementById('resposta').innerHTML = data.resposta.replace(/\n/g, '<br>');
                document.getElementById('contexto').textContent = data.contexto;
            })
            .catch(error => {
                document.getElementById('loading').classList.add('hidden');
                alert('Erro ao processar pergunta: ' + error.message);
            });
        }
    </script>
</body>
</html>
